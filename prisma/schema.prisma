generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" 
}

enum MediaType {
  IMAGE
  VIDEO
  NONE
}

enum QuestionType {
  THEORY
  SIMULATION
}

enum LicenseType {
  A1
  A2
  A3
  A4
  B1
  B2
  C
  D
  E
  F
}

enum QuestionGroup {
  CONCEPTS_RULES   
  CULTURE_ETHICS    
  TECHNIQUES        
  STRUCTURE_REPAIR  
  TRAFFIC_SIGNS     
  TRAFFIC_FIGURES   
}

enum TestStatus {
  PASS
  FAIL
}

enum BookmarkType {
  WRONG_AUTO
  MANUAL
}

enum TrafficSignGroup {
  PROHIBITION  
  DANGER      
  COMMAND      
  INSTRUCTION  
  AUXILIARY   
  MARKING     
}

model User {
  id           Int            @id @default(autoincrement())
  email        String         @unique
  password     String
  fullName     String?        @map("full_name")
  avatarUrl    String?        @map("avatar_url")
  refreshToken String?        @map("refresh_token")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  histories    TestHistory[]
  bookmarks    UserBookmark[]
  isVerified Boolean @default(false) @map("is_verified")
  verificationCode String? @map("verification_code")
  @@map("users")
}

model Question {
  id           Int           @id @default(autoincrement())
  content      String
  mediaUrl     String?       @map("media_url")
  mediaType    MediaType     @default(NONE) @map("media_type")
  questionType QuestionType  @default(THEORY) @map("question_type")
  group        QuestionGroup @default(CONCEPTS_RULES)
  isParalysis  Boolean       @default(false) @map("is_paralysis")
  explanation  String?       
  tip          String?       
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  answers          Answer[]
  examSetQuestions ExamSetQuestion[]
  testDetails      TestDetail[]
  bookmarks        UserBookmark[]
  trafficSignId    Int?          @map("traffic_sign_id")
  trafficSign      TrafficSign?  @relation(fields: [trafficSignId], references: [id])
  @@map("questions")
  @@index([group])
  @@index([isParalysis])
}

model Answer {
  id          Int          @id @default(autoincrement())
  questionId  Int          @map("question_id")
  content     String
  isCorrect   Boolean      @default(false) @map("is_correct")
  question    Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  testDetails TestDetail[]
  @@map("answers")
}

model TrafficSign {
  id          Int        @id @default(autoincrement())
  code        String     @unique 
  name        String
  description String?
  imageUrl    String     @map("image_url")
  group       TrafficSignGroup @map("group")
  questions   Question[]
  @@map("traffic_signs")
}

model ExamSet {
  id          Int               @id @default(autoincrement())
  name        String
  licenseType LicenseType       @map("license_type")
  description String?
  questions   ExamSetQuestion[]
  testHistory TestHistory[]
  @@map("exam_sets")
}

model ExamSetQuestion {
  examSetId  Int @map("exam_set_id")
  questionId Int @map("question_id")
  examSet    ExamSet  @relation(fields: [examSetId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  @@id([examSetId, questionId])
  @@map("exam_set_questions")
}

model TestHistory {
  id                Int         @id @default(autoincrement())
  userId            Int         @map("user_id")
  examSetId         Int?        @map("exam_set_id")
  licenseType       LicenseType @map("license_type")
  score             Int
  totalQuestions    Int         @map("total_questions")
  status            TestStatus
  isParalysisFailed Boolean     @default(false) @map("is_paralysis_failed")
  durationSeconds   Int         @map("duration_seconds")
  createdAt         DateTime    @default(now()) @map("created_at")
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  examSet           ExamSet?    @relation(fields: [examSetId], references: [id])
  details           TestDetail[]
  @@map("test_history")
  @@index([userId])
}

model TestDetail {
  id               Int     @id @default(autoincrement())
  testHistoryId    Int     @map("test_history_id")
  questionId       Int     @map("question_id")
  selectedAnswerId Int?    @map("selected_answer_id")
  isCorrect        Boolean @map("is_correct")
  history          TestHistory @relation(fields: [testHistoryId], references: [id], onDelete: Cascade)
  question         Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedAnswer   Answer?     @relation(fields: [selectedAnswerId], references: [id])
  @@map("test_details")
  @@index([questionId, isCorrect])
}

model UserBookmark {
  id           Int          @id @default(autoincrement())
  userId       Int          @map("user_id")
  questionId   Int          @map("question_id")
  bookmarkType BookmarkType @map("bookmark_type")
  note         String?
  createdAt    DateTime     @default(now()) @map("created_at")
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  question     Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId, bookmarkType])
  @@map("user_bookmarks")
}

model GeneralStudyTip {
  id          Int          @id @default(autoincrement())
  title       String
  content     String       @db.Text
  licenseType LicenseType? 
  @@map("general_study_tips")
}